<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LibVNCServer/LibVNCClient: vnc2mpg.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">LibVNCServer/LibVNCClient
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">vnc2mpg.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Simple movie writer for vnc; based on Libavformat API example from FFMPEGCopyright (c) 2003 Fabrice Bellard, 2004 Johannes E. Schindelin Updates copyright (c) 2017 Tyrel M. McQueen</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;math.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sys/time.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;libavformat/avformat.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;libswscale/swscale.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rfbclient_8h.html">rfb/rfbclient.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define VNC_PIX_FMT       AV_PIX_FMT_RGB565  </span><span class="comment">/* pixel format generated by VNC client */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define OUTPUT_PIX_FMT    AV_PIX_FMT_YUV420P </span><span class="comment">/* default pix_fmt */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> write_packet(AVFormatContext *<a name="a0"></a><a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>, <span class="keyword">const</span> AVRational *time_base, AVStream *st, AVPacket *pkt)</div><div class="line">{</div><div class="line">    <span class="comment">/* rescale output packet timestamp values from codec to stream timebase */</span></div><div class="line">    av_packet_rescale_ts(pkt, *time_base, st-&gt;time_base);</div><div class="line">    pkt-&gt;stream_index = st-&gt;index;</div><div class="line">    <span class="comment">/* Write the compressed frame to the media file. */</span></div><div class="line">    <span class="keywordflow">return</span> av_interleaved_write_frame(oc, pkt);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*************************************************/</span></div><div class="line"><span class="comment">/* video functions                               */</span></div><div class="line"></div><div class="line"><span class="comment">/* a wrapper around a single output video stream */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">    AVStream *st;</div><div class="line">    AVCodec *codec;</div><div class="line">    AVCodecContext *enc;</div><div class="line">    int64_t pts;</div><div class="line">    AVFrame *frame;</div><div class="line">    AVFrame *tmp_frame;</div><div class="line">    <span class="keyword">struct </span>SwsContext *sws;</div><div class="line">} <a name="_a1"></a><a class="code" href="struct_video_output_stream.html">VideoOutputStream</a>;</div><div class="line"></div><div class="line"><span class="comment">/* Add an output video stream. */</span></div><div class="line"><span class="keywordtype">int</span> <a name="a2"></a><a class="code" href="vnc2mpg_8c.html#abc6889a1426b82361498b7bdd23cdfd4">add_video_stream</a>(<a class="code" href="struct_video_output_stream.html">VideoOutputStream</a> *ost, AVFormatContext *<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>,</div><div class="line">                       <span class="keyword">enum</span> AVCodecID codec_id, int64_t br, <span class="keywordtype">int</span> sr, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> i;</div><div class="line"></div><div class="line">    <span class="comment">/* find the encoder */</span></div><div class="line">    ost-&gt;<a name="a3"></a><a class="code" href="struct_video_output_stream.html#a3d92780da6f5146c4f47f425dd151d96">codec</a> = avcodec_find_encoder(codec_id);</div><div class="line">    <span class="keywordflow">if</span> (!(ost-&gt;<a class="code" href="struct_video_output_stream.html#a3d92780da6f5146c4f47f425dd151d96">codec</a>)) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not find encoder for &#39;%s&#39;\n&quot;</span>,</div><div class="line">                avcodec_get_name(codec_id));</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    } <span class="comment">// no extra memory allocation from this call</span></div><div class="line">    <span class="keywordflow">if</span> (ost-&gt;<a class="code" href="struct_video_output_stream.html#a3d92780da6f5146c4f47f425dd151d96">codec</a>-&gt;type != AVMEDIA_TYPE_VIDEO) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Encoder for &#39;%s&#39; does not seem to be for video.\n&quot;</span>,</div><div class="line">                avcodec_get_name(codec_id));</div><div class="line">        <span class="keywordflow">return</span> -2;</div><div class="line">    }</div><div class="line">    ost-&gt;<a name="a4"></a><a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a> = avcodec_alloc_context3(ost-&gt;<a class="code" href="struct_video_output_stream.html#a3d92780da6f5146c4f47f425dd151d96">codec</a>);</div><div class="line">    <span class="keywordflow">if</span> (!(ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>)) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not alloc an encoding context\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> -3;</div><div class="line">    } <span class="comment">// from now on need to call avcodec_free_context(&amp;(ost-&gt;enc)) on error</span></div><div class="line"></div><div class="line">    <span class="comment">/* Set codec parameters */</span></div><div class="line">    ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;codec_id = codec_id;</div><div class="line">    ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;bit_rate = br;</div><div class="line">    <span class="comment">/* Resolution must be a multiple of two (round up to avoid buffer overflow). */</span></div><div class="line">    ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;width    = w + (w % 2);</div><div class="line">    ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;height   = h + (h % 2);</div><div class="line">    <span class="comment">/* timebase: This is the fundamental unit of time (in seconds) in terms</span></div><div class="line"><span class="comment">     * of which frame timestamps are represented. For fixed-fps content,</span></div><div class="line"><span class="comment">     * timebase should be 1/framerate and timestamp increments should be</span></div><div class="line"><span class="comment">     * identical to 1. */</span></div><div class="line">    ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;time_base      = (AVRational){ 1, sr };</div><div class="line">    ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;gop_size      = 12; <span class="comment">/* emit one intra frame every twelve frames at most */</span></div><div class="line">    ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;pix_fmt       = <a name="a5"></a><a class="code" href="vnc2mpg_8c.html#a52668684889e3b3fd09c8170827eb2bc">OUTPUT_PIX_FMT</a>;</div><div class="line">    <span class="keywordflow">if</span> (ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;codec_id == AV_CODEC_ID_MPEG1VIDEO) {</div><div class="line">        <span class="comment">/* Needed to avoid using macroblocks in which some coeffs overflow.</span></div><div class="line"><span class="comment">         * This does not happen with normal video, it just happens here as</span></div><div class="line"><span class="comment">         * the motion of the chroma plane does not match the luma plane. */</span></div><div class="line">        ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;mb_decision = 2;</div><div class="line">    }</div><div class="line"></div><div class="line">    ost-&gt;<a name="a6"></a><a class="code" href="struct_video_output_stream.html#a6a92ceb1975fa810dd63ef7ec71da773">st</a> = avformat_new_stream(<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>, ost-&gt;<a class="code" href="struct_video_output_stream.html#a3d92780da6f5146c4f47f425dd151d96">codec</a>);</div><div class="line">    <span class="keywordflow">if</span> (!ost-&gt;<a class="code" href="struct_video_output_stream.html#a6a92ceb1975fa810dd63ef7ec71da773">st</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not allocate stream\n&quot;</span>);</div><div class="line">        avcodec_free_context(&amp;(ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>));</div><div class="line">        <span class="keywordflow">return</span> -4;</div><div class="line">    } <span class="comment">// stream memory cleared up when oc is freed, so no need to do so later in this function on error</span></div><div class="line">    ost-&gt;<a class="code" href="struct_video_output_stream.html#a6a92ceb1975fa810dd63ef7ec71da773">st</a>-&gt;id = <a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>-&gt;nb_streams-1;</div><div class="line">    ost-&gt;<a class="code" href="struct_video_output_stream.html#a6a92ceb1975fa810dd63ef7ec71da773">st</a>-&gt;time_base = ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;time_base;</div><div class="line">    ost-&gt;<a name="a7"></a><a class="code" href="struct_video_output_stream.html#a4fbb704fb96c36a78a36eee010306ce7">pts</a> = 0;</div><div class="line"></div><div class="line">    <span class="comment">/* Some formats want stream headers to be separate. */</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER)</div><div class="line">        ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;flags |= AV_CODEC_FLAG_GLOBAL_HEADER;</div><div class="line"></div><div class="line">    <span class="comment">// must wait to allocate frame buffers until codec is opened (in case codec changes the PIX_FMT)</span></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line">AVFrame *<a name="a8"></a><a class="code" href="vnc2mpg_8c.html#a6617ea96debf017c216c5ae98c6e1ef1">alloc_picture</a>(<span class="keyword">enum</span> AVPixelFormat pix_fmt, <span class="keywordtype">int</span> <a name="a9"></a><a class="code" href="vncev_8c.html#a667b04d7fb6ef46db4da4af554c5b6f7">width</a>, <span class="keywordtype">int</span> <a name="a10"></a><a class="code" href="vncev_8c.html#a64f9f90ece96c7bab4aee3deacf170e0">height</a>)</div><div class="line">{</div><div class="line">    AVFrame *picture;</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line">    picture = av_frame_alloc();</div><div class="line">    <span class="keywordflow">if</span> (!picture)</div><div class="line">        <span class="keywordflow">return</span> NULL;</div><div class="line">        <span class="comment">// from now on need to call av_frame_free(&amp;picture) on error</span></div><div class="line">    picture-&gt;format = pix_fmt;</div><div class="line">    picture-&gt;width  = <a class="code" href="vncev_8c.html#a667b04d7fb6ef46db4da4af554c5b6f7">width</a>;</div><div class="line">    picture-&gt;height = <a class="code" href="vncev_8c.html#a64f9f90ece96c7bab4aee3deacf170e0">height</a>;</div><div class="line">    <span class="comment">/* allocate the buffers for the frame data */</span></div><div class="line">    ret = av_frame_get_buffer(picture, 64);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not allocate frame data.\n&quot;</span>);</div><div class="line">        av_frame_free(&amp;picture);</div><div class="line">        <span class="keywordflow">return</span> NULL;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> picture;</div><div class="line">} <span class="comment">// use av_frame_free(&amp;picture) to free memory from this call</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a11"></a><a class="code" href="vnc2mpg_8c.html#a8e56ffdf2b7120254398781ba2b40e21">open_video</a>(AVFormatContext *<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>, <a class="code" href="struct_video_output_stream.html">VideoOutputStream</a> *ost)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line">    <span class="comment">/* open the codec */</span></div><div class="line">    ret = avcodec_open2(ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>, ost-&gt;<a class="code" href="struct_video_output_stream.html#a3d92780da6f5146c4f47f425dd151d96">codec</a>, NULL);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not open video codec: %s\n&quot;</span>, av_err2str(ret));</div><div class="line">        <span class="keywordflow">return</span> ret;</div><div class="line">    } <span class="comment">// memory from this call freed when oc is freed, no need to do it on error in this call</span></div><div class="line">    <span class="comment">/* copy the stream parameters to the muxer */</span></div><div class="line">    ret = avcodec_parameters_from_context(ost-&gt;<a class="code" href="struct_video_output_stream.html#a6a92ceb1975fa810dd63ef7ec71da773">st</a>-&gt;codecpar, ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not copy the stream parameters.\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> ret;</div><div class="line">    } <span class="comment">// memory from this call is freed when oc (parent of ost-&gt;st) is freed, no need to do it on error in this call</span></div><div class="line">    <span class="comment">/* allocate and init a re-usable frame */</span></div><div class="line">    ost-&gt;<a name="a12"></a><a class="code" href="struct_video_output_stream.html#ad7d33d579a8d4241a5e643e39287a209">frame</a> = <a class="code" href="vnc2mpg_8c.html#a6617ea96debf017c216c5ae98c6e1ef1">alloc_picture</a>(ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;pix_fmt, ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;width, ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;height);</div><div class="line">    <span class="keywordflow">if</span> (!(ost-&gt;<a class="code" href="struct_video_output_stream.html#ad7d33d579a8d4241a5e643e39287a209">frame</a>)) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not allocate video frame\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    } <span class="comment">// from now on need to call av_frame_free(&amp;(ost-&gt;frame)) on error</span></div><div class="line">    <span class="comment">/* If the output format is not the same as the VNC format, then a temporary VNC format</span></div><div class="line"><span class="comment">     * picture is needed too. It is then converted to the required</span></div><div class="line"><span class="comment">     * output format. */</span></div><div class="line">    ost-&gt;<a name="a13"></a><a class="code" href="struct_video_output_stream.html#a23998c92326de56ddf3b1addd67f25de">tmp_frame</a> = NULL;</div><div class="line">    ost-&gt;<a name="a14"></a><a class="code" href="struct_video_output_stream.html#a24e987044037dd4ee9c4803694e630d8">sws</a> = NULL;</div><div class="line">    <span class="keywordflow">if</span> (ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;pix_fmt != <a name="a15"></a><a class="code" href="vnc2mpg_8c.html#aa6d8f1b861b8dc222ea39a7cc11ffd07">VNC_PIX_FMT</a>) {</div><div class="line">        ost-&gt;<a class="code" href="struct_video_output_stream.html#a23998c92326de56ddf3b1addd67f25de">tmp_frame</a> = <a class="code" href="vnc2mpg_8c.html#a6617ea96debf017c216c5ae98c6e1ef1">alloc_picture</a>(<a class="code" href="vnc2mpg_8c.html#aa6d8f1b861b8dc222ea39a7cc11ffd07">VNC_PIX_FMT</a>, ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;width, ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;height);</div><div class="line">        <span class="keywordflow">if</span> (!(ost-&gt;<a class="code" href="struct_video_output_stream.html#a23998c92326de56ddf3b1addd67f25de">tmp_frame</a>)) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Could not allocate temporary picture\n&quot;</span>);</div><div class="line">            av_frame_free(&amp;(ost-&gt;<a class="code" href="struct_video_output_stream.html#ad7d33d579a8d4241a5e643e39287a209">frame</a>));</div><div class="line">            <span class="keywordflow">return</span> -2;</div><div class="line">        } <span class="comment">// from now on need to call av_frame_free(&amp;(ost-&gt;tmp_frame)) on error</span></div><div class="line">        ost-&gt;<a class="code" href="struct_video_output_stream.html#a24e987044037dd4ee9c4803694e630d8">sws</a> = sws_getCachedContext(ost-&gt;<a class="code" href="struct_video_output_stream.html#a24e987044037dd4ee9c4803694e630d8">sws</a>, ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;width, ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;height, <a class="code" href="vnc2mpg_8c.html#aa6d8f1b861b8dc222ea39a7cc11ffd07">VNC_PIX_FMT</a>, ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;width, ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;height, ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;pix_fmt, 0, NULL, NULL, NULL);</div><div class="line">        <span class="keywordflow">if</span> (!(ost-&gt;<a class="code" href="struct_video_output_stream.html#a24e987044037dd4ee9c4803694e630d8">sws</a>)) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Could not get sws context\n&quot;</span>);</div><div class="line">            av_frame_free(&amp;(ost-&gt;<a class="code" href="struct_video_output_stream.html#ad7d33d579a8d4241a5e643e39287a209">frame</a>));</div><div class="line">            av_frame_free(&amp;(ost-&gt;<a class="code" href="struct_video_output_stream.html#a23998c92326de56ddf3b1addd67f25de">tmp_frame</a>));</div><div class="line">            <span class="keywordflow">return</span> -3;</div><div class="line">        } <span class="comment">// from now on need to call sws_freeContext(ost-&gt;sws); ost-&gt;sws = NULL; on error</span></div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * encode current video frame and send it to the muxer</span></div><div class="line"><span class="comment"> * return 0 on success, negative on error</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">int</span> <a name="a16"></a><a class="code" href="vnc2mpg_8c.html#a0bc3f07512bea6f483328e00507622c9">write_video_frame</a>(AVFormatContext *<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>, <a class="code" href="struct_video_output_stream.html">VideoOutputStream</a> *ost, int64_t pts)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> ret, ret2;</div><div class="line">    AVPacket pkt = { 0 };</div><div class="line">    <span class="keywordflow">if</span> (pts &lt;= ost-&gt;pts) <span class="keywordflow">return</span> 0; <span class="comment">// nothing to do</span></div><div class="line">    <span class="comment">/* convert format if needed */</span></div><div class="line">    <span class="keywordflow">if</span> (ost-&gt;<a class="code" href="struct_video_output_stream.html#a23998c92326de56ddf3b1addd67f25de">tmp_frame</a>) {</div><div class="line">        sws_scale(ost-&gt;<a class="code" href="struct_video_output_stream.html#a24e987044037dd4ee9c4803694e630d8">sws</a>, (<span class="keyword">const</span> uint8_t * <span class="keyword">const</span> *)ost-&gt;<a class="code" href="struct_video_output_stream.html#a23998c92326de56ddf3b1addd67f25de">tmp_frame</a>-&gt;data,</div><div class="line">                    ost-&gt;<a class="code" href="struct_video_output_stream.html#a23998c92326de56ddf3b1addd67f25de">tmp_frame</a>-&gt;linesize, 0, ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;height, ost-&gt;<a class="code" href="struct_video_output_stream.html#ad7d33d579a8d4241a5e643e39287a209">frame</a>-&gt;data, ost-&gt;<a class="code" href="struct_video_output_stream.html#ad7d33d579a8d4241a5e643e39287a209">frame</a>-&gt;linesize);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* send the imager to encoder */</span></div><div class="line">    ost-&gt;<a class="code" href="struct_video_output_stream.html#a4fbb704fb96c36a78a36eee010306ce7">pts</a> = pts;</div><div class="line">    ost-&gt;<a class="code" href="struct_video_output_stream.html#ad7d33d579a8d4241a5e643e39287a209">frame</a>-&gt;pts = ost-&gt;<a class="code" href="struct_video_output_stream.html#a4fbb704fb96c36a78a36eee010306ce7">pts</a>;</div><div class="line">    ret = avcodec_send_frame(ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>, ost-&gt;<a class="code" href="struct_video_output_stream.html#ad7d33d579a8d4241a5e643e39287a209">frame</a>);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error sending video frame to encoder: %s\n&quot;</span>, av_err2str(ret));</div><div class="line">        <span class="keywordflow">return</span> ret;</div><div class="line">    }</div><div class="line">    <span class="comment">/* read all available packets */</span></div><div class="line">    ret2 = 0;</div><div class="line">    <span class="keywordflow">for</span> (ret = avcodec_receive_packet(ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>, &amp;pkt); ret == 0; ret = avcodec_receive_packet(ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>, &amp;pkt)) {</div><div class="line">        ret2 = write_packet(<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>, &amp;(ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;time_base), ost-&gt;<a class="code" href="struct_video_output_stream.html#a6a92ceb1975fa810dd63ef7ec71da773">st</a>, &amp;pkt);</div><div class="line">        <span class="keywordflow">if</span> (ret2 &lt; 0) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Error while writing video frame: %s\n&quot;</span>, av_err2str(ret2));</div><div class="line">            <span class="comment">/* continue on this error to not gum up encoder */</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (ret2 &lt; 0) <span class="keywordflow">return</span> ret2;</div><div class="line">    <span class="keywordflow">if</span> (!(ret == AVERROR(EAGAIN))) <span class="keywordflow">return</span> ret; <span class="comment">// if AVERROR(EAGAIN), means all available packets output, need more frames (i.e. success)</span></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Write final video frame (i.e. drain codec).</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordtype">int</span> <a name="a17"></a><a class="code" href="vnc2mpg_8c.html#aacbcd28b0790f8720d4071b76f553458">write_final_video_frame</a>(AVFormatContext *<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>, <a class="code" href="struct_video_output_stream.html">VideoOutputStream</a> *ost)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> ret, ret2;</div><div class="line">    AVPacket pkt = { 0 };</div><div class="line"></div><div class="line">    <span class="comment">/* send NULL image to encoder */</span></div><div class="line">    ret = avcodec_send_frame(ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>, NULL);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error sending final video frame to encoder: %s\n&quot;</span>, av_err2str(ret));</div><div class="line">        <span class="keywordflow">return</span> ret;</div><div class="line">    }</div><div class="line">    <span class="comment">/* read all available packets */</span></div><div class="line">    ret2 = 0;</div><div class="line">    <span class="keywordflow">for</span> (ret = avcodec_receive_packet(ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>, &amp;pkt); ret == 0; ret = avcodec_receive_packet(ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>, &amp;pkt)) {</div><div class="line">        ret2 = write_packet(<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>, &amp;(ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>-&gt;time_base), ost-&gt;<a class="code" href="struct_video_output_stream.html#a6a92ceb1975fa810dd63ef7ec71da773">st</a>, &amp;pkt);</div><div class="line">        <span class="keywordflow">if</span> (ret2 &lt; 0) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Error while writing final video frame: %s\n&quot;</span>, av_err2str(ret2));</div><div class="line">            <span class="comment">/* continue on this error to not gum up encoder */</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (ret2 &lt; 0) <span class="keywordflow">return</span> ret2;</div><div class="line">    <span class="keywordflow">if</span> (!(ret == AVERROR(EOF))) <span class="keywordflow">return</span> ret;</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a18"></a><a class="code" href="vnc2mpg_8c.html#af8b75d30beeb1528c92f7fe0487e620e">close_video_stream</a>(<a class="code" href="struct_video_output_stream.html">VideoOutputStream</a> *ost)</div><div class="line">{</div><div class="line">    avcodec_free_context(&amp;(ost-&gt;<a class="code" href="struct_video_output_stream.html#a9532a2ea8b7fc0df351312679ef8d7bf">enc</a>));</div><div class="line">    av_frame_free(&amp;(ost-&gt;<a class="code" href="struct_video_output_stream.html#ad7d33d579a8d4241a5e643e39287a209">frame</a>));</div><div class="line">    av_frame_free(&amp;(ost-&gt;<a class="code" href="struct_video_output_stream.html#a23998c92326de56ddf3b1addd67f25de">tmp_frame</a>));</div><div class="line">    sws_freeContext(ost-&gt;<a class="code" href="struct_video_output_stream.html#a24e987044037dd4ee9c4803694e630d8">sws</a>); ost-&gt;<a class="code" href="struct_video_output_stream.html#a24e987044037dd4ee9c4803694e630d8">sws</a> = NULL;</div><div class="line">    ost-&gt;<a class="code" href="struct_video_output_stream.html#a3d92780da6f5146c4f47f425dd151d96">codec</a> = NULL; <span class="comment">/* codec not an allocated item */</span></div><div class="line">    ost-&gt;<a class="code" href="struct_video_output_stream.html#a6a92ceb1975fa810dd63ef7ec71da773">st</a> = NULL; <span class="comment">/* freeing parent oc will free this memory */</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/**************************************************************/</span></div><div class="line"><span class="comment">/* Output movie handling */</span></div><div class="line">AVFormatContext *<a name="a19"></a><a class="code" href="vnc2mpg_8c.html#a97b7085eabc3cd2a95d349bd24adf441">movie_open</a>(<span class="keywordtype">char</span> *<a name="a20"></a><a class="code" href="vnc2mpg_8c.html#aeac90097f29f7529968697163cea5c18">filename</a>, <a class="code" href="struct_video_output_stream.html">VideoOutputStream</a> *<a name="a21"></a><a class="code" href="vnc2mpg_8c.html#a14f1b65e5f87f33e3287a5f78dd574d5">video_st</a>, <span class="keywordtype">int</span> br, <span class="keywordtype">int</span> fr, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h) {</div><div class="line">    <span class="keywordtype">int</span> ret;</div><div class="line">    AVFormatContext *<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>;</div><div class="line"></div><div class="line">    <span class="comment">/* allocate the output media context. */</span></div><div class="line">    ret = avformat_alloc_output_context2(&amp;oc, NULL, NULL, <a class="code" href="vnc2mpg_8c.html#aeac90097f29f7529968697163cea5c18">filename</a>);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Warning: Could not deduce output format from file extension: using MP4.\n&quot;</span>);</div><div class="line">        ret = avformat_alloc_output_context2(&amp;oc, NULL, <span class="stringliteral">&quot;mp4&quot;</span>, <a class="code" href="vnc2mpg_8c.html#aeac90097f29f7529968697163cea5c18">filename</a>);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error: Could not allocate media context: %s.\n&quot;</span>, av_err2str(ret));</div><div class="line">        <span class="keywordflow">return</span> NULL;</div><div class="line">    } <span class="comment">// from now on, need to call avformat_free_context(oc); oc=NULL; to free memory on error</span></div><div class="line"></div><div class="line">    <span class="comment">/* Add the video stream using the default format codec and initialize the codec. */</span></div><div class="line">    <span class="keywordflow">if</span> (oc-&gt;oformat-&gt;video_codec != AV_CODEC_ID_NONE) {</div><div class="line">        ret = <a class="code" href="vnc2mpg_8c.html#abc6889a1426b82361498b7bdd23cdfd4">add_video_stream</a>(video_st, oc, oc-&gt;oformat-&gt;video_codec, br, fr, w, h);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        ret = -1;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error: chosen output format does not have a video codec, or error %i\n&quot;</span>, ret);</div><div class="line">        avformat_free_context(oc); oc = NULL;</div><div class="line">        <span class="keywordflow">return</span> NULL;</div><div class="line">    } <span class="comment">// from now on, need to call close_video_stream(video_st) to free memory on error</span></div><div class="line"></div><div class="line">    <span class="comment">/* Now that all the parameters are set, we can open the codecs and allocate the necessary encode buffers. */</span></div><div class="line">    ret = <a class="code" href="vnc2mpg_8c.html#a8e56ffdf2b7120254398781ba2b40e21">open_video</a>(oc, video_st); </div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error: error opening video codec, error %i\n&quot;</span>, ret);</div><div class="line">        <a class="code" href="vnc2mpg_8c.html#af8b75d30beeb1528c92f7fe0487e620e">close_video_stream</a>(video_st);</div><div class="line">        avformat_free_context(oc); oc = NULL;</div><div class="line">        <span class="keywordflow">return</span> NULL;</div><div class="line">    } <span class="comment">// no additional calls required to free memory, as close_video_stream(video_st) will do it</span></div><div class="line"></div><div class="line">    <span class="comment">/* open the output file, if needed */</span></div><div class="line">    <span class="keywordflow">if</span> (!(oc-&gt;oformat-&gt;flags &amp; AVFMT_NOFILE)) {</div><div class="line">        ret = avio_open(&amp;oc-&gt;pb, <a class="code" href="vnc2mpg_8c.html#aeac90097f29f7529968697163cea5c18">filename</a>, AVIO_FLAG_WRITE);</div><div class="line">        <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Could not open &#39;%s&#39;: %s\n&quot;</span>, <a class="code" href="vnc2mpg_8c.html#aeac90097f29f7529968697163cea5c18">filename</a>,</div><div class="line">                    av_err2str(ret));</div><div class="line">            <a class="code" href="vnc2mpg_8c.html#af8b75d30beeb1528c92f7fe0487e620e">close_video_stream</a>(video_st);</div><div class="line">            avformat_free_context(oc); oc = NULL;</div><div class="line">            <span class="keywordflow">return</span> NULL;</div><div class="line">        }</div><div class="line">    } <span class="comment">// will need to call avio_closep(&amp;oc-&gt;pb) to free file handle on error</span></div><div class="line"></div><div class="line">    <span class="comment">/* Write the stream header, if any. */</span></div><div class="line">    ret = avformat_write_header(oc, NULL);</div><div class="line">    <span class="keywordflow">if</span> (ret &lt; 0) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error occurred when writing to output file: %s\n&quot;</span>,</div><div class="line">                av_err2str(ret));</div><div class="line">        <span class="keywordflow">if</span> (!(oc-&gt;oformat-&gt;flags &amp; AVFMT_NOFILE))</div><div class="line">            avio_closep(&amp;oc-&gt;pb);</div><div class="line">        <a class="code" href="vnc2mpg_8c.html#af8b75d30beeb1528c92f7fe0487e620e">close_video_stream</a>(video_st);</div><div class="line">        avformat_free_context(oc); oc = NULL;</div><div class="line">    } <span class="comment">// no additional items to free</span></div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a22"></a><a class="code" href="vnc2mpg_8c.html#a7177a8366cc5afbf927326d293194e75">movie_close</a>(AVFormatContext **ocp, <a class="code" href="struct_video_output_stream.html">VideoOutputStream</a> *video_st) {</div><div class="line">    AVFormatContext *<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a> = *ocp;</div><div class="line">    <span class="comment">/* Write the trailer, if any. The trailer must be written before you</span></div><div class="line"><span class="comment">     * close the CodecContexts open when you wrote the header; otherwise</span></div><div class="line"><span class="comment">     * av_write_trailer() may try to use memory that was freed on</span></div><div class="line"><span class="comment">     * av_codec_close(). */</span></div><div class="line">    <span class="keywordflow">if</span> (oc) {</div><div class="line">        <span class="keywordflow">if</span> (video_st)</div><div class="line">            <a class="code" href="vnc2mpg_8c.html#aacbcd28b0790f8720d4071b76f553458">write_final_video_frame</a>(oc, video_st);</div><div class="line"></div><div class="line">        av_write_trailer(oc);</div><div class="line"></div><div class="line">        <span class="comment">/* Close the video codec. */</span></div><div class="line">        <a class="code" href="vnc2mpg_8c.html#af8b75d30beeb1528c92f7fe0487e620e">close_video_stream</a>(video_st);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (!(oc-&gt;oformat-&gt;flags &amp; AVFMT_NOFILE))</div><div class="line">            <span class="comment">/* Close the output file. */</span></div><div class="line">            avio_closep(&amp;oc-&gt;pb);</div><div class="line"></div><div class="line">        <span class="comment">/* free the stream */</span></div><div class="line">        avformat_free_context(oc);</div><div class="line">        ocp = NULL;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/**************************************************************/</span></div><div class="line"><span class="comment">/* VNC globals */</span></div><div class="line"><a class="code" href="struct_video_output_stream.html">VideoOutputStream</a> video_st = { 0 };</div><div class="line"><a name="_a23"></a><a class="code" href="structrfb_client.html">rfbClient</a> *<a name="a24"></a><a class="code" href="vnc2mpg_8c.html#ac37cb17b305822d8d05c6adf0d8036f1">client</a> = NULL;</div><div class="line"><a class="code" href="rfbproto_8h.html#a329f406ebc51f975c9df984a6b98c74d">rfbBool</a> <a name="a25"></a><a class="code" href="vnc2mpg_8c.html#a79a7fd9f2f1661fcd180b42084c28fbe">quit</a> = <a name="a26"></a><a class="code" href="rfbproto_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><span class="keywordtype">char</span> *<a class="code" href="vnc2mpg_8c.html#aeac90097f29f7529968697163cea5c18">filename</a> = NULL;</div><div class="line">AVFormatContext *<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a> = NULL;</div><div class="line"><span class="keywordtype">int</span> <a name="a27"></a><a class="code" href="vnc2mpg_8c.html#ab5d8e1788d02d0e52941a0778776e289">bitrate</a> = 1000000;</div><div class="line"><span class="keywordtype">int</span> <a name="a28"></a><a class="code" href="vnc2mpg_8c.html#a0e35b8d74e1ac59b82f506293654d26d">framerate</a> = 5;</div><div class="line"><span class="keywordtype">long</span> <a name="a29"></a><a class="code" href="vnc2mpg_8c.html#a10c1ddf4a13d02f8fb4cb489846fce03">max_time</a> = 0;</div><div class="line"><span class="keyword">struct </span>timespec start_time, <a name="a30"></a><a class="code" href="vnc2mpg_8c.html#a6b4807fd854cf175d773f5cc61089b48">cur_time</a>;</div><div class="line"></div><div class="line"><span class="comment">/* Signal handling */</span></div><div class="line"><span class="keywordtype">void</span> <a name="a31"></a><a class="code" href="vnc2mpg_8c.html#a3b527c56ed133ee6815bfbc625e757af">signal_handler</a>(<span class="keywordtype">int</span> signal) {</div><div class="line">        <a class="code" href="vnc2mpg_8c.html#a79a7fd9f2f1661fcd180b42084c28fbe">quit</a>=<a name="a32"></a><a class="code" href="rfbproto_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* returns time since start in pts units */</span></div><div class="line">int64_t <a name="a33"></a><a class="code" href="vnc2mpg_8c.html#aa7b8c6aed61427a47375c18b7173cead">time_to_pts</a>(<span class="keywordtype">int</span> <a class="code" href="vnc2mpg_8c.html#a0e35b8d74e1ac59b82f506293654d26d">framerate</a>, <span class="keyword">struct</span> timespec *start_time, <span class="keyword">struct</span> timespec *<a class="code" href="vnc2mpg_8c.html#a6b4807fd854cf175d773f5cc61089b48">cur_time</a>) {</div><div class="line">    time_t ds = cur_time-&gt;tv_sec - start_time-&gt;tv_sec;</div><div class="line">    <span class="keywordtype">long</span> dns = cur_time-&gt;tv_nsec - start_time-&gt;tv_nsec;</div><div class="line">    <span class="comment">/* use usecs */</span></div><div class="line">    int64_t dt = (int64_t)ds*(int64_t)1000000+(int64_t)dns/(int64_t)1000;</div><div class="line">    <span class="comment">/* compute rv in units of frame number (rounding to nearest, not truncating) */</span></div><div class="line">    int64_t rv = (((int64_t)<a class="code" href="vnc2mpg_8c.html#a0e35b8d74e1ac59b82f506293654d26d">framerate</a>)*dt + (int64_t)500000) / (int64_t)(1000000);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> rv;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* VNC callback functions */</span></div><div class="line"><a class="code" href="rfbproto_8h.html#a329f406ebc51f975c9df984a6b98c74d">rfbBool</a> <a name="a34"></a><a class="code" href="vnc2mpg_8c.html#aec8ebc550111e0085f2b3101dd2275f5">vnc_malloc_fb</a>(<a class="code" href="structrfb_client.html">rfbClient</a>* client) {</div><div class="line">        <a class="code" href="vnc2mpg_8c.html#a7177a8366cc5afbf927326d293194e75">movie_close</a>(&amp;<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>, &amp;video_st);</div><div class="line">        <a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a> = <a class="code" href="vnc2mpg_8c.html#a97b7085eabc3cd2a95d349bd24adf441">movie_open</a>(<a class="code" href="vnc2mpg_8c.html#aeac90097f29f7529968697163cea5c18">filename</a>, &amp;video_st, <a class="code" href="vnc2mpg_8c.html#ab5d8e1788d02d0e52941a0778776e289">bitrate</a>, <a class="code" href="vnc2mpg_8c.html#a0e35b8d74e1ac59b82f506293654d26d">framerate</a>, client-&gt;<a name="a35"></a><a class="code" href="structrfb_client.html#a2474a5474cbff19523a51eb1de01cda4">width</a>, client-&gt;<a name="a36"></a><a class="code" href="structrfb_client.html#ad12fc34ce789bce6c8a05d8a17138534">height</a>);</div><div class="line">        <span class="keywordflow">if</span> (!<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>) </div><div class="line">            <span class="keywordflow">return</span> <a class="code" href="rfbproto_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line">        signal(SIGINT,<a class="code" href="vnc2mpg_8c.html#a3b527c56ed133ee6815bfbc625e757af">signal_handler</a>);</div><div class="line">        signal(SIGTERM,<a class="code" href="vnc2mpg_8c.html#a3b527c56ed133ee6815bfbc625e757af">signal_handler</a>);</div><div class="line">        signal(SIGQUIT,<a class="code" href="vnc2mpg_8c.html#a3b527c56ed133ee6815bfbc625e757af">signal_handler</a>);</div><div class="line">        signal(SIGABRT,<a class="code" href="vnc2mpg_8c.html#a3b527c56ed133ee6815bfbc625e757af">signal_handler</a>);</div><div class="line">        <span class="comment">/* These assignments assumes the AVFrame buffer is contigous. This is true in current ffmpeg versions for</span></div><div class="line"><span class="comment">         * most non-HW accelerated bits, but may not be true globally. */</span></div><div class="line">        <span class="keywordflow">if</span>(video_st.<a class="code" href="struct_video_output_stream.html#a23998c92326de56ddf3b1addd67f25de">tmp_frame</a>)</div><div class="line">                client-&gt;<a name="a37"></a><a class="code" href="structrfb_client.html#a9a2fdf82b1d05e2a1cbcb68ad1237ae4">frameBuffer</a>=video_st.<a class="code" href="struct_video_output_stream.html#a23998c92326de56ddf3b1addd67f25de">tmp_frame</a>-&gt;data[0];</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">                client-&gt;<a class="code" href="structrfb_client.html#a9a2fdf82b1d05e2a1cbcb68ad1237ae4">frameBuffer</a>=video_st.<a class="code" href="struct_video_output_stream.html#ad7d33d579a8d4241a5e643e39287a209">frame</a>-&gt;data[0];</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="rfbproto_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a38"></a><a class="code" href="vnc2mpg_8c.html#adb067ba28d5ec81498f818b5f651e949">vnc_update</a>(<a class="code" href="structrfb_client.html">rfbClient</a>* client,<span class="keywordtype">int</span> <a name="a39"></a><a class="code" href="_s_d_lvncviewer_8c.html#a6150e0515f7202e2fb518f7206ed97dc">x</a>,<span class="keywordtype">int</span> <a name="a40"></a><a class="code" href="_s_d_lvncviewer_8c.html#a0a2f84ed7838f07779ae24c5a9086d33">y</a>,<span class="keywordtype">int</span> w,<span class="keywordtype">int</span> h) {</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/**************************************************************/</span></div><div class="line"><span class="comment">/* media file output */</span></div><div class="line"><span class="keywordtype">int</span> <a name="a41"></a><a class="code" href="vnc2mpg_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> i,j;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize vnc client structure (don&#39;t connect yet). */</span></div><div class="line">    client = <a name="a42"></a><a class="code" href="group__libvncclient__api.html#ga13e0666f04539bf2a0f36af961e9506a">rfbGetClient</a>(5,3,2);</div><div class="line">    client-&gt;<a name="a43"></a><a class="code" href="structrfb_client.html#afe12707797380d4d71f0869554206d3f">format</a>.<a name="a44"></a><a class="code" href="structrfb_pixel_format.html#ae15e89a5090279dd2fca4453a3a3f20a">redShift</a>=11; client-&gt;<a class="code" href="structrfb_client.html#afe12707797380d4d71f0869554206d3f">format</a>.<a name="a45"></a><a class="code" href="structrfb_pixel_format.html#a07ca53b709f723484418082b4511540a">redMax</a>=31;</div><div class="line">    client-&gt;<a class="code" href="structrfb_client.html#afe12707797380d4d71f0869554206d3f">format</a>.<a name="a46"></a><a class="code" href="structrfb_pixel_format.html#a5f4558aed9088231e0fddf264f292d60">greenShift</a>=5; client-&gt;<a class="code" href="structrfb_client.html#afe12707797380d4d71f0869554206d3f">format</a>.<a name="a47"></a><a class="code" href="structrfb_pixel_format.html#a188ea8035a1b7b1c177341b6c75edae3">greenMax</a>=63;</div><div class="line">    client-&gt;<a class="code" href="structrfb_client.html#afe12707797380d4d71f0869554206d3f">format</a>.<a name="a48"></a><a class="code" href="structrfb_pixel_format.html#aa0f291475e78e329f47c870e3a540596">blueShift</a>=0; client-&gt;<a class="code" href="structrfb_client.html#afe12707797380d4d71f0869554206d3f">format</a>.<a name="a49"></a><a class="code" href="structrfb_pixel_format.html#a24b0b5716ded786484ea655d7ed1a4d1">blueMax</a>=31;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize libavcodec, and register all codecs and formats. */</span></div><div class="line"><span class="preprocessor">#if LIBAVUTIL_VERSION_MAJOR &lt; 56 </span><span class="comment">/* deprecrated in FFMPEG 4.0 */</span><span class="preprocessor"></span></div><div class="line">    av_register_all();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    <span class="comment">/* Parse command line. */</span></div><div class="line">    <span class="keywordflow">for</span>(i=1;i&lt;argc;i++) {</div><div class="line">            j=i;</div><div class="line">            <span class="keywordflow">if</span>(argc&gt;i+1 &amp;&amp; !strcmp(<span class="stringliteral">&quot;-o&quot;</span>,argv[i])) {</div><div class="line">                    <a class="code" href="vnc2mpg_8c.html#aeac90097f29f7529968697163cea5c18">filename</a>=argv[i+1];</div><div class="line">                    j+=2;</div><div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(argc&gt;i+1 &amp;&amp; !strcmp(<span class="stringliteral">&quot;-t&quot;</span>,argv[i])) {</div><div class="line">                    <a class="code" href="vnc2mpg_8c.html#a10c1ddf4a13d02f8fb4cb489846fce03">max_time</a>=atol(argv[i+1]);</div><div class="line">                    <span class="keywordflow">if</span> (max_time &lt; 10 || max_time &gt; 100000000) {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;Warning: Nonsensical time-per-file %li, resetting to default.\n&quot;</span>, <a class="code" href="vnc2mpg_8c.html#a10c1ddf4a13d02f8fb4cb489846fce03">max_time</a>);</div><div class="line">                        <a class="code" href="vnc2mpg_8c.html#a10c1ddf4a13d02f8fb4cb489846fce03">max_time</a> = 0;</div><div class="line">                    }</div><div class="line">                    j+=2;</div><div class="line">            }</div><div class="line">            <span class="comment">/* This is so that argc/argv are ready for passing to rfbInitClient */</span></div><div class="line">            <span class="keywordflow">if</span>(j&gt;i) {</div><div class="line">                    argc-=j-i;</div><div class="line">                    memmove(argv+i,argv+j,(argc-i)*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>*));</div><div class="line">                    i--;</div><div class="line">            }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* default filename. */</span></div><div class="line">    <span class="keywordflow">if</span> (!<a class="code" href="vnc2mpg_8c.html#aeac90097f29f7529968697163cea5c18">filename</a>) {</div><div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Warning: No filename specified. Using output.mp4\n&quot;</span>);</div><div class="line">        <a class="code" href="vnc2mpg_8c.html#aeac90097f29f7529968697163cea5c18">filename</a> = <span class="stringliteral">&quot;output.mp4&quot;</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* open VNC connection. */</span></div><div class="line">    client-&gt;<a name="a50"></a><a class="code" href="structrfb_client.html#af0100dc33c8e9078e06992240d7c6861">MallocFrameBuffer</a>=<a class="code" href="vnc2mpg_8c.html#aec8ebc550111e0085f2b3101dd2275f5">vnc_malloc_fb</a>;</div><div class="line">    client-&gt;<a name="a51"></a><a class="code" href="structrfb_client.html#a2a826e6f505e2a569dca4e56822ad65e">GotFrameBufferUpdate</a>=<a class="code" href="vnc2mpg_8c.html#adb067ba28d5ec81498f818b5f651e949">vnc_update</a>;</div><div class="line">    <span class="keywordflow">if</span>(!<a name="a52"></a><a class="code" href="group__libvncclient__api.html#gabb2299d1644f3cf38544eb97d2356475">rfbInitClient</a>(client,&amp;argc,argv)) {</div><div class="line">        printf(<span class="stringliteral">&quot;usage: %s [-o output_file] [-t seconds-per-file] server:port\n&quot;</span>, argv[0]);</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* main loop */</span></div><div class="line">    clock_gettime(CLOCK_MONOTONIC, &amp;start_time);</div><div class="line">    <span class="keywordflow">while</span>(!<a class="code" href="vnc2mpg_8c.html#a79a7fd9f2f1661fcd180b42084c28fbe">quit</a>) {</div><div class="line">        <span class="keywordtype">int</span> i=<a name="a53"></a><a class="code" href="group__libvncclient__api.html#ga154dcdd94ef439dc8d57dd14bf1e1c59">WaitForMessage</a>(client,10000/<a class="code" href="vnc2mpg_8c.html#a0e35b8d74e1ac59b82f506293654d26d">framerate</a>); <span class="comment">/* useful for timeout to be no more than 10 msec per second (=10000/framerate usec) */</span></div><div class="line">        <span class="keywordflow">if</span> (i&gt;0) {</div><div class="line">            <span class="keywordflow">if</span>(!<a name="a54"></a><a class="code" href="group__libvncclient__api.html#gaa9ba8ed8e74e27e9c4095e0190d2aad9">HandleRFBServerMessage</a>(client))</div><div class="line">                <a class="code" href="vnc2mpg_8c.html#a79a7fd9f2f1661fcd180b42084c28fbe">quit</a>=<a class="code" href="rfbproto_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i&lt;0) {</div><div class="line">            <a class="code" href="vnc2mpg_8c.html#a79a7fd9f2f1661fcd180b42084c28fbe">quit</a>=<a class="code" href="rfbproto_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (!<a class="code" href="vnc2mpg_8c.html#a79a7fd9f2f1661fcd180b42084c28fbe">quit</a>) {</div><div class="line">            clock_gettime(CLOCK_MONOTONIC, &amp;<a class="code" href="vnc2mpg_8c.html#a6b4807fd854cf175d773f5cc61089b48">cur_time</a>);</div><div class="line">            <a class="code" href="vnc2mpg_8c.html#a0bc3f07512bea6f483328e00507622c9">write_video_frame</a>(<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>, &amp;video_st, <a class="code" href="vnc2mpg_8c.html#aa7b8c6aed61427a47375c18b7173cead">time_to_pts</a>(<a class="code" href="vnc2mpg_8c.html#a0e35b8d74e1ac59b82f506293654d26d">framerate</a>, &amp;start_time, &amp;<a class="code" href="vnc2mpg_8c.html#a6b4807fd854cf175d773f5cc61089b48">cur_time</a>));</div><div class="line">            <span class="keywordflow">if</span> ((<a class="code" href="vnc2mpg_8c.html#a6b4807fd854cf175d773f5cc61089b48">cur_time</a>.tv_sec - start_time.tv_sec) &gt; <a class="code" href="vnc2mpg_8c.html#a10c1ddf4a13d02f8fb4cb489846fce03">max_time</a> &amp;&amp; <a class="code" href="vnc2mpg_8c.html#a10c1ddf4a13d02f8fb4cb489846fce03">max_time</a> &gt; 0) {</div><div class="line">                <a class="code" href="vnc2mpg_8c.html#a79a7fd9f2f1661fcd180b42084c28fbe">quit</a> = <a class="code" href="rfbproto_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <a class="code" href="vnc2mpg_8c.html#a7177a8366cc5afbf927326d293194e75">movie_close</a>(&amp;<a class="code" href="vnc2mpg_8c.html#a1d0a159a05f649c8e2b333dd64b63259">oc</a>,&amp;video_st);</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Jun 13 2020 13:15:42 for LibVNCServer/LibVNCClient by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
