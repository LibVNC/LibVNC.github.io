<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LibVNCServer/LibVNCClient: camera.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">LibVNCServer/LibVNCClient
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">camera.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Question: I need to display a live camera image via VNC. Until now I just grab an image, set the rect to modified and do a 0.1 s sleep to give the system time to transfer the data. This is obviously a solution which doesn't scale very well to different connection speeds/cpu horsepowers, so I wonder if there is a way for the server application to determine if the updates have been sent. This would cause the live image update rate to always be the maximum the connection supports while avoiding excessive loads.</p>
<p>Thanks in advance,</p>
<p>Christian Daschill</p>
<p>Answer: Originally, I thought about using separate threads and using a mutex to determine when the frame buffer was being accessed by any client so we could determine a safe time to take a picture. The probem is, we are lock-stepping everything with framebuffer access. Why not be a single-thread application and in-between rfbProcessEvents perform a camera snapshot. And this is what I do here. It guarantees that the clients have been serviced before taking another picture.</p>
<p>The downside to this approach is that the more clients you have, there is less time available for you to service the camera equating to reduced frame rate. (or, your clients are on really slow links). Increasing your systems ethernet transmit queues may help improve the overall performance as the libvncserver should not stall on transmitting to any single client.</p>
<p>Another solution would be to provide a separate framebuffer for each client and use mutexes to determine if any particular client is ready for a snapshot. This way, your not updating a framebuffer for a slow client while it is being transferred.</p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rfb_8h.html">rfb/rfb.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#ifdef LIBVNCSERVER_HAVE_GETTIMEOFDAY</span></div>
<div class="line"><span class="comment">/* if we have gettimeofday(), it is in this header */</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/time.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#if !defined LIBVNCSERVER_HAVE_GETTIMEOFDAY &amp;&amp; defined WIN32</span></div>
<div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;conio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/timeb.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> gettimeofday(<span class="keyword">struct</span> timeval* tv,<span class="keywordtype">char</span>* dummy)</div>
<div class="line">{</div>
<div class="line">   SYSTEMTIME t;</div>
<div class="line">   GetSystemTime(&amp;t);</div>
<div class="line">   tv-&gt;tv_sec=t.wHour*3600+t.wMinute*60+t.wSecond;</div>
<div class="line">   tv-&gt;tv_usec=t.wMilliseconds*1000;</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define WIDTH  640</span></div>
<div class="line"><span class="preprocessor">#define HEIGHT 480</span></div>
<div class="line"><span class="preprocessor">#define BPP      4</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* 15 frames per second (if we can) */</span></div>
<div class="line"><span class="preprocessor">#define PICTURE_TIMEOUT (1.0/15.0)</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * throttle camera updates</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"><span class="keywordtype">int</span> <a name="a0"></a><a class="code" href="camera_8c.html#af6f08e3c92a8e79780b52c8438e0363c">TimeToTakePicture</a>() {</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">struct </span>timeval now={0,0}, then={0,0};</div>
<div class="line">    <span class="keywordtype">double</span> elapsed, dnow, dthen;</div>
<div class="line"> </div>
<div class="line">    gettimeofday(&amp;now,NULL);</div>
<div class="line"> </div>
<div class="line">    dnow  = now.tv_sec  + (now.tv_usec /1000000.0);</div>
<div class="line">    dthen = then.tv_sec + (then.tv_usec/1000000.0);</div>
<div class="line">    elapsed = dnow - dthen;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (elapsed &gt; <a name="a1"></a><a class="code" href="camera_8c.html#a7294a2f84ccd42d5de7cb3ca655a52ce">PICTURE_TIMEOUT</a>)</div>
<div class="line">      memcpy((<span class="keywordtype">char</span> *)&amp;then, (<span class="keywordtype">char</span> *)&amp;now, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> timeval));</div>
<div class="line">    <span class="keywordflow">return</span> elapsed &gt; <a class="code" href="camera_8c.html#a7294a2f84ccd42d5de7cb3ca655a52ce">PICTURE_TIMEOUT</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * simulate grabbing a picture from some device</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> <a name="a2"></a><a class="code" href="camera_8c.html#a3bf27110afe2299a3ca2d8689c622ebe">TakePicture</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buffer)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">int</span> last_line=0, fps=0, fcount=0;</div>
<div class="line">  <span class="keywordtype">int</span> line=0;</div>
<div class="line">  <span class="keywordtype">int</span> i,j;</div>
<div class="line">  <span class="keyword">struct </span>timeval now;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * simulate grabbing data from a device by updating the entire framebuffer</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">for</span>(j=0;j&lt;<a name="a3"></a><a class="code" href="camera_8c.html#aed89bd71aee8be823e8a20ec4e093c1e">HEIGHT</a>;++j) {</div>
<div class="line">    <span class="keywordflow">for</span>(i=0;i&lt;<a name="a4"></a><a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a>;++i) {</div>
<div class="line">      buffer[(j*<a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a>+i)*<a name="a5"></a><a class="code" href="camera_8c.html#a8f40226da14df1fe52cd78fcda4ec5cb">BPP</a>+0]=(i+j)*128/(<a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a>+<a class="code" href="camera_8c.html#aed89bd71aee8be823e8a20ec4e093c1e">HEIGHT</a>); <span class="comment">/* red */</span></div>
<div class="line">      buffer[(j*<a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a>+i)*<a class="code" href="camera_8c.html#a8f40226da14df1fe52cd78fcda4ec5cb">BPP</a>+1]=i*128/<a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a>; <span class="comment">/* green */</span></div>
<div class="line">      buffer[(j*<a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a>+i)*<a class="code" href="camera_8c.html#a8f40226da14df1fe52cd78fcda4ec5cb">BPP</a>+2]=j*256/<a class="code" href="camera_8c.html#aed89bd71aee8be823e8a20ec4e093c1e">HEIGHT</a>; <span class="comment">/* blue */</span></div>
<div class="line">    }</div>
<div class="line">    buffer[j*<a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a>*<a class="code" href="camera_8c.html#a8f40226da14df1fe52cd78fcda4ec5cb">BPP</a>+0]=0xff;</div>
<div class="line">    buffer[j*<a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a>*<a class="code" href="camera_8c.html#a8f40226da14df1fe52cd78fcda4ec5cb">BPP</a>+1]=0xff;</div>
<div class="line">    buffer[j*<a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a>*<a class="code" href="camera_8c.html#a8f40226da14df1fe52cd78fcda4ec5cb">BPP</a>+2]=0xff;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * simulate the passage of time</span></div>
<div class="line"><span class="comment">   *</span></div>
<div class="line"><span class="comment">   * draw a simple black line that moves down the screen. The faster the</span></div>
<div class="line"><span class="comment">   * client, the more updates it will get, the smoother it will look!</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  gettimeofday(&amp;now,NULL);</div>
<div class="line">  line = now.tv_usec / (1000000/<a class="code" href="camera_8c.html#aed89bd71aee8be823e8a20ec4e093c1e">HEIGHT</a>);</div>
<div class="line">  <span class="keywordflow">if</span> (line&gt;=<a class="code" href="camera_8c.html#aed89bd71aee8be823e8a20ec4e093c1e">HEIGHT</a>) line=<a class="code" href="camera_8c.html#aed89bd71aee8be823e8a20ec4e093c1e">HEIGHT</a>-1;</div>
<div class="line">  memset(&amp;buffer[(<a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a> * <a class="code" href="camera_8c.html#a8f40226da14df1fe52cd78fcda4ec5cb">BPP</a>) * line], 0, (<a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a> * <a class="code" href="camera_8c.html#a8f40226da14df1fe52cd78fcda4ec5cb">BPP</a>));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* frames per second (informational only) */</span></div>
<div class="line">  fcount++;</div>
<div class="line">  <span class="keywordflow">if</span> (last_line &gt; line) {</div>
<div class="line">    fps = fcount;</div>
<div class="line">    fcount = 0;</div>
<div class="line">  }</div>
<div class="line">  last_line = line;</div>
<div class="line">  fprintf(stderr,<span class="stringliteral">&quot;%03d/%03d Picture (%03d fps)\r&quot;</span>, line, <a class="code" href="camera_8c.html#aed89bd71aee8be823e8a20ec4e093c1e">HEIGHT</a>, fps);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* success!   We have a new picture! */</span></div>
<div class="line">  <span class="keywordflow">return</span> (1==1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">/* </span></div>
<div class="line"><span class="comment"> * Single-threaded application that interleaves client servicing with taking</span></div>
<div class="line"><span class="comment"> * pictures from the camera.  This way, we do not update the framebuffer</span></div>
<div class="line"><span class="comment"> * while an encoding is working on it too (banding, and image artifacts).</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> <a name="a6"></a><a class="code" href="camera_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc,<span class="keywordtype">char</span>** argv)</div>
<div class="line">{                                       </div>
<div class="line">  <span class="keywordtype">long</span> usec;</div>
<div class="line">  </div>
<div class="line">  rfbScreenInfoPtr server=<a name="a7"></a><a class="code" href="group__libvncserver__api.html#ga7bc0e73d60a80ddc855fe1c4313fe57d">rfbGetScreen</a>(&amp;argc,argv,<a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a>,<a class="code" href="camera_8c.html#aed89bd71aee8be823e8a20ec4e093c1e">HEIGHT</a>,8,3,<a class="code" href="camera_8c.html#a8f40226da14df1fe52cd78fcda4ec5cb">BPP</a>);</div>
<div class="line">  <span class="keywordflow">if</span>(!server)</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">  server-&gt;desktopName = <span class="stringliteral">&quot;Live Video Feed Example&quot;</span>;</div>
<div class="line">  server-&gt;frameBuffer=(<span class="keywordtype">char</span>*)malloc(<a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a>*<a class="code" href="camera_8c.html#aed89bd71aee8be823e8a20ec4e093c1e">HEIGHT</a>*<a class="code" href="camera_8c.html#a8f40226da14df1fe52cd78fcda4ec5cb">BPP</a>);</div>
<div class="line">  server-&gt;alwaysShared=(1==1);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Initialize the server */</span></div>
<div class="line">  <a name="a8"></a><a class="code" href="group__libvncserver__api.html#ga0fb612a193a96424b82b9a5e7b494e73">rfbInitServer</a>(server);           </div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Loop, processing clients and taking pictures */</span></div>
<div class="line">  <span class="keywordflow">while</span> (<a name="a9"></a><a class="code" href="group__libvncserver__api.html#ga8d95458dd102510f8dfc48b645b6a5cf">rfbIsActive</a>(server)) {</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="camera_8c.html#af6f08e3c92a8e79780b52c8438e0363c">TimeToTakePicture</a>())</div>
<div class="line">      <span class="keywordflow">if</span> (<a class="code" href="camera_8c.html#a3bf27110afe2299a3ca2d8689c622ebe">TakePicture</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)server-&gt;frameBuffer))</div>
<div class="line">        <a name="a10"></a><a class="code" href="group__libvncserver__api.html#ga4063480bb7e8d337ea2948638957ff75">rfbMarkRectAsModified</a>(server,0,0,<a class="code" href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a>,<a class="code" href="camera_8c.html#aed89bd71aee8be823e8a20ec4e093c1e">HEIGHT</a>);</div>
<div class="line">          </div>
<div class="line">    usec = server-&gt;deferUpdateTime*1000;</div>
<div class="line">    <a name="a11"></a><a class="code" href="group__libvncserver__api.html#ga94e550459ace749f762f8e891930d55b">rfbProcessEvents</a>(server,usec);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span>(0);</div>
<div class="line">}</div>
<div class="ttc" id="acamera_8c_html_a241aeeb764887ae5e3de58b98f04b16d"><div class="ttname"><a href="camera_8c.html#a241aeeb764887ae5e3de58b98f04b16d">WIDTH</a></div><div class="ttdeci">#define WIDTH</div><div class="ttdef"><b>Definition:</b> <a href="camera_8c_source.html#l00063">camera.c:63</a></div></div>
<div class="ttc" id="acamera_8c_html_a3bf27110afe2299a3ca2d8689c622ebe"><div class="ttname"><a href="camera_8c.html#a3bf27110afe2299a3ca2d8689c622ebe">TakePicture</a></div><div class="ttdeci">int TakePicture(unsigned char *buffer)</div><div class="ttdef"><b>Definition:</b> <a href="camera_8c_source.html#l00094">camera.c:94</a></div></div>
<div class="ttc" id="acamera_8c_html_a3c04138a5bfe5d72780bb7e82a18e627"><div class="ttname"><a href="camera_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a></div><div class="ttdeci">int main(int argc, char **argv)</div><div class="ttdef"><b>Definition:</b> <a href="camera_8c_source.html#l00148">camera.c:148</a></div></div>
<div class="ttc" id="acamera_8c_html_a7294a2f84ccd42d5de7cb3ca655a52ce"><div class="ttname"><a href="camera_8c.html#a7294a2f84ccd42d5de7cb3ca655a52ce">PICTURE_TIMEOUT</a></div><div class="ttdeci">#define PICTURE_TIMEOUT</div><div class="ttdef"><b>Definition:</b> <a href="camera_8c_source.html#l00068">camera.c:68</a></div></div>
<div class="ttc" id="acamera_8c_html_a8f40226da14df1fe52cd78fcda4ec5cb"><div class="ttname"><a href="camera_8c.html#a8f40226da14df1fe52cd78fcda4ec5cb">BPP</a></div><div class="ttdeci">#define BPP</div><div class="ttdef"><b>Definition:</b> <a href="camera_8c_source.html#l00065">camera.c:65</a></div></div>
<div class="ttc" id="acamera_8c_html_aed89bd71aee8be823e8a20ec4e093c1e"><div class="ttname"><a href="camera_8c.html#aed89bd71aee8be823e8a20ec4e093c1e">HEIGHT</a></div><div class="ttdeci">#define HEIGHT</div><div class="ttdef"><b>Definition:</b> <a href="camera_8c_source.html#l00064">camera.c:64</a></div></div>
<div class="ttc" id="acamera_8c_html_af6f08e3c92a8e79780b52c8438e0363c"><div class="ttname"><a href="camera_8c.html#af6f08e3c92a8e79780b52c8438e0363c">TimeToTakePicture</a></div><div class="ttdeci">int TimeToTakePicture()</div><div class="ttdef"><b>Definition:</b> <a href="camera_8c_source.html#l00074">camera.c:74</a></div></div>
<div class="ttc" id="agroup__libvncserver__api_html_ga0fb612a193a96424b82b9a5e7b494e73"><div class="ttname"><a href="group__libvncserver__api.html#ga0fb612a193a96424b82b9a5e7b494e73">rfbInitServer</a></div><div class="ttdeci">void rfbInitServer(rfbScreenInfoPtr rfbScreen)</div></div>
<div class="ttc" id="agroup__libvncserver__api_html_ga4063480bb7e8d337ea2948638957ff75"><div class="ttname"><a href="group__libvncserver__api.html#ga4063480bb7e8d337ea2948638957ff75">rfbMarkRectAsModified</a></div><div class="ttdeci">void rfbMarkRectAsModified(rfbScreenInfoPtr rfbScreen, int x1, int y1, int x2, int y2)</div></div>
<div class="ttc" id="agroup__libvncserver__api_html_ga7bc0e73d60a80ddc855fe1c4313fe57d"><div class="ttname"><a href="group__libvncserver__api.html#ga7bc0e73d60a80ddc855fe1c4313fe57d">rfbGetScreen</a></div><div class="ttdeci">rfbScreenInfoPtr rfbGetScreen(int *argc, char **argv, int width, int height, int bitsPerSample, int samplesPerPixel, int bytesPerPixel)</div></div>
<div class="ttc" id="agroup__libvncserver__api_html_ga8d95458dd102510f8dfc48b645b6a5cf"><div class="ttname"><a href="group__libvncserver__api.html#ga8d95458dd102510f8dfc48b645b6a5cf">rfbIsActive</a></div><div class="ttdeci">rfbBool rfbIsActive(rfbScreenInfoPtr screenInfo)</div></div>
<div class="ttc" id="agroup__libvncserver__api_html_ga94e550459ace749f762f8e891930d55b"><div class="ttname"><a href="group__libvncserver__api.html#ga94e550459ace749f762f8e891930d55b">rfbProcessEvents</a></div><div class="ttdeci">rfbBool rfbProcessEvents(rfbScreenInfoPtr screenInfo, long usec)</div></div>
<div class="ttc" id="arfb_8h_html"><div class="ttname"><a href="rfb_8h.html">rfb.h</a></div></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Dec 18 2022 21:08:29 for LibVNCServer/LibVNCClient by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
